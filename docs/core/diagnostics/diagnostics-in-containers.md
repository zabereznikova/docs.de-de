---
title: Sammeln von Diagnosen in Containern
description: In diesem Artikel erfahren Sie, wie Sie .NET Core-Diagnosetools in Docker-Containern verwenden können.
ms.date: 09/01/2020
ms.openlocfilehash: e57f3696433bbf6f35b2e3e5d1e72ae8b1e3eeb3
ms.sourcegitcommit: b4a46f6d7ebf44c0035627d00924164bcae2db30
ms.translationtype: HT
ms.contentlocale: de-DE
ms.lasthandoff: 09/29/2020
ms.locfileid: "91450834"
---
# <a name="collect-diagnostics-in-containers"></a><span data-ttu-id="9ab6f-103">Sammeln von Diagnosen in Containern</span><span class="sxs-lookup"><span data-stu-id="9ab6f-103">Collect diagnostics in containers</span></span>

<span data-ttu-id="9ab6f-104">Die gleichen Diagnosetools, die für die Diagnose von .NET Core-Problemen in anderen Szenarien nützlich sind, funktionieren auch in Docker-Containern.</span><span class="sxs-lookup"><span data-stu-id="9ab6f-104">The same diagnostics tools that are useful for diagnosing .NET Core issues in other scenarios also work in Docker containers.</span></span> <span data-ttu-id="9ab6f-105">Für einige Tools sind jedoch spezielle Schritte erforderlich, damit sie in einem Container funktionieren.</span><span class="sxs-lookup"><span data-stu-id="9ab6f-105">However, some of the tools require special steps to work in a container.</span></span> <span data-ttu-id="9ab6f-106">In diesem Artikel wird beschrieben, wie Tools zum Sammeln von Leistungsüberwachungsdaten und Speicherabbildern in Docker-Containern verwendet werden können.</span><span class="sxs-lookup"><span data-stu-id="9ab6f-106">This article covers how tools for gathering performance traces and collecting dumps can be used in Docker containers.</span></span>

## <a name="using-net-core-cli-tools-in-a-container"></a><span data-ttu-id="9ab6f-107">Verwenden von .NET Core-CLI-Tools in einem Container</span><span class="sxs-lookup"><span data-stu-id="9ab6f-107">Using .NET Core CLI tools in a container</span></span>

<span data-ttu-id="9ab6f-108">**Diese Tools gelten für: ✔️** .NET Core 3.0 SDK und neuere Versionen</span><span class="sxs-lookup"><span data-stu-id="9ab6f-108">**These tools apply to: ✔️** .NET Core 3.0 SDK and later versions</span></span>

<span data-ttu-id="9ab6f-109">Die globalen .NET Core-CLI-Diagnosetools ([`dotnet-counters`](dotnet-counters.md), [`dotnet-dump`](dotnet-dump.md), [`dotnet-gcdump`](dotnet-gcdump.md) und [`dotnet-trace`](dotnet-trace.md)) sind so konzipiert, dass sie in einer Vielzahl von Umgebungen und somit direkt in Docker-Containern eingesetzt werden können.</span><span class="sxs-lookup"><span data-stu-id="9ab6f-109">The .NET Core global CLI diagnostic tools ([`dotnet-counters`](dotnet-counters.md), [`dotnet-dump`](dotnet-dump.md), [`dotnet-gcdump`](dotnet-gcdump.md), and [`dotnet-trace`](dotnet-trace.md)) are designed to work in a wide variety of environments and should all work directly in Docker containers.</span></span> <span data-ttu-id="9ab6f-110">Aus diesem Grund stellen diese Tools die bevorzugte Methode dar, um in .NET Core-Szenarien für .NET Core 3.0 oder höher (bzw. 3.1 oder höher im Fall von `dotnet-gcdump`) Diagnoseinformationen in Containern zu sammeln.</span><span class="sxs-lookup"><span data-stu-id="9ab6f-110">Because of this, these tools are the preferred method of collecting diagnostic information for .NET Core scenarios targeting .NET Core 3.0 or above (or 3.1 or above in the case of `dotnet-gcdump`) in containers.</span></span>

<span data-ttu-id="9ab6f-111">Der einzige erschwerende Faktor bei der Verwendung dieser Tools in einem Container besteht darin, dass sie mit dem .NET Core SDK installiert werden und dass viele Docker-Container ohne das .NET Core SDK ausgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="9ab6f-111">The only complicating factor of using these tools in a container is that they are installed with the .NET Core SDK and many Docker containers run without the .NET Core SDK present.</span></span> <span data-ttu-id="9ab6f-112">Eine einfache Lösung für dieses Problem besteht darin, die Tools im anfänglichen Docker-Image zu installieren.</span><span class="sxs-lookup"><span data-stu-id="9ab6f-112">One easy solution to this problem is to install the tools in the initial Docker image.</span></span> <span data-ttu-id="9ab6f-113">Das .NET Core SDK muss für die Tools nicht ausgeführt, sondern nur installiert werden.</span><span class="sxs-lookup"><span data-stu-id="9ab6f-113">The tools don't need the .NET Core SDK to run, only to be installed.</span></span> <span data-ttu-id="9ab6f-114">Daher ist es möglich, ein Dockerfile mit einem [mehrstufigen Build](https://docs.docker.com/develop/develop-images/multistage-build/) zu erstellen, der die Tools in einer Buildstage installiert (in der das .NET Core SDK enthalten ist) und dann die Binärdateien in das endgültige Image kopiert.</span><span class="sxs-lookup"><span data-stu-id="9ab6f-114">Therefore, it's possible to create a Dockerfile with a [multi-stage build](https://docs.docker.com/develop/develop-images/multistage-build/) that installs the tools in a build stage (where the .NET Core SDK is present) and then copies the binaries into the final image.</span></span> <span data-ttu-id="9ab6f-115">Der einzige Nachteil dieses Ansatzes besteht in der Größe des Docker-Images.</span><span class="sxs-lookup"><span data-stu-id="9ab6f-115">The only downside to this approach is increased Docker image size.</span></span>

```dockerfile
# In build stage
# Install desired .NET CLI diagnostics tools
RUN dotnet tool install --tool-path /tools dotnet-trace
RUN dotnet tool install --tool-path /tools dotnet-counters
RUN dotnet tool install --tool-path /tools dotnet-dump

...

# In final stage
# Copy diagnostics tools
WORKDIR /tools
COPY --from=build /tools .
```

<span data-ttu-id="9ab6f-116">Alternativ dazu kann das .NET Core SDK bei Bedarf in einem Container installiert werden, um die CLI-Tools zu installieren.</span><span class="sxs-lookup"><span data-stu-id="9ab6f-116">Alternatively, the .NET Core SDK can be installed in a container when needed in order to install the CLI tools.</span></span> <span data-ttu-id="9ab6f-117">Beachten Sie, dass durch die Installation des .NET Core SDK als Nebeneffekt die .NET Core-Runtime neu installiert wird.</span><span class="sxs-lookup"><span data-stu-id="9ab6f-117">Be aware that installing the .NET Core SDK will have the side-effect of reinstalling the .NET Core runtime.</span></span> <span data-ttu-id="9ab6f-118">Stellen Sie sicher, dass Sie die SDK-Version installieren, die der im Container vorliegenden Runtime entspricht.</span><span class="sxs-lookup"><span data-stu-id="9ab6f-118">So be sure to install the version of the SDK that matches the runtime present in the container.</span></span>

### <a name="using-net-core-global-cli-tools-in-a-sidecar-container"></a><span data-ttu-id="9ab6f-119">Verwenden globaler CLI-Tools von .NET Core in einem Sidecarcontainer</span><span class="sxs-lookup"><span data-stu-id="9ab6f-119">Using .NET Core global CLI tools in a sidecar container</span></span>

<span data-ttu-id="9ab6f-120">Wenn Sie die globalen CLI-Diagnosetools von .NET Core zur Diagnose von Prozessen in einem anderen Container verwenden möchten, müssen Sie die folgenden zusätzlichen Anforderungen beachten:</span><span class="sxs-lookup"><span data-stu-id="9ab6f-120">If you would like to use .NET Core global CLI diagnostic tools to diagnose processes in a different container, bear the following additional requirements in mind:</span></span>

1. <span data-ttu-id="9ab6f-121">Die Container müssen einen [Prozessnamespace](https://docs.docker.com/engine/reference/run/#pid-settings---pid) freigeben (damit Tools im Sidecarcontainer auf Prozesse im Zielcontainer zugreifen können).</span><span class="sxs-lookup"><span data-stu-id="9ab6f-121">The containers must [share a process namespace](https://docs.docker.com/engine/reference/run/#pid-settings---pid) (so that tools in the sidecar container can access processes in the target container).</span></span>
2. <span data-ttu-id="9ab6f-122">Die globalen CLI-Diagnosetools von .NET Core benötigen Zugriff auf Dateien, die von der .NET Core-Runtime in das Verzeichnis „/tmp“ geschrieben werden. Daher muss das Verzeichnis „/tmp“ über eine Volumebereitstellung von Ziel- und Sidecarcontainer gemeinsam genutzt werden.</span><span class="sxs-lookup"><span data-stu-id="9ab6f-122">The .NET Core global CLI diagnostic tools need access to files the .NET Core runtime writes to the /tmp directory, so the /tmp directory must be shared between the target and sidecar container via a volume mount.</span></span> <span data-ttu-id="9ab6f-123">Dies lässt sich beispielsweise umsetzen, indem die Container ein [Volume](https://docs.docker.com/storage/volumes/#create-and-manage-volumes) oder ein Kubernetes-[emptyDir](https://kubernetes.io/docs/concepts/storage/volumes/#emptydir)-Volume gemeinsam verwenden.</span><span class="sxs-lookup"><span data-stu-id="9ab6f-123">This could be done, for example, by having the containers share a common [volume](https://docs.docker.com/storage/volumes/#create-and-manage-volumes) or a Kubernetes [emptyDir](https://kubernetes.io/docs/concepts/storage/volumes/#emptydir) volume.</span></span> <span data-ttu-id="9ab6f-124">Wenn Sie versuchen, die Diagnosetools von einem Sidecarcontainer aus zu verwenden, ohne das Verzeichnis „/tmp“ freizugeben, erhalten Sie eine Fehlermeldung, dass der Prozess „keine kompatible .NET-Runtime ausführt“.</span><span class="sxs-lookup"><span data-stu-id="9ab6f-124">If you attempt to use the diagnostic tools from a sidecar container without sharing the /tmp directory, you will get an error about the process "not running compatible .NET runtime."</span></span>

## <a name="using-perfcollect-in-a-container"></a><span data-ttu-id="9ab6f-125">Verwenden von `PerfCollect` in einem Container</span><span class="sxs-lookup"><span data-stu-id="9ab6f-125">Using `PerfCollect` in a container</span></span>

<span data-ttu-id="9ab6f-126">**Dieses Tool gilt für: ✔️** .NET Core 2.1 und neuere Versionen</span><span class="sxs-lookup"><span data-stu-id="9ab6f-126">**This tool applies to: ✔️** .NET Core 2.1 and later versions</span></span>

<span data-ttu-id="9ab6f-127">Das [`PerfCollect`](https://github.com/dotnet/coreclr/blob/master/Documentation/project-docs/linux-performance-tracing.md)-Skript ist für die Sammlung von Leistungsüberwachungsdaten nützlich und wird für die Erfassung von Überwachungsdaten vor .NET Core 3.0 empfohlen.</span><span class="sxs-lookup"><span data-stu-id="9ab6f-127">The [`PerfCollect`](https://github.com/dotnet/coreclr/blob/master/Documentation/project-docs/linux-performance-tracing.md) script is useful for collecting performance traces and is the recommended tool for collecting traces prior to .NET Core 3.0.</span></span> <span data-ttu-id="9ab6f-128">Wenn Sie `PerfCollect` in einem Container verwenden, beachten Sie die folgenden Anforderungen:</span><span class="sxs-lookup"><span data-stu-id="9ab6f-128">If using `PerfCollect` in a container, keep the following requirements in mind:</span></span>

1. <span data-ttu-id="9ab6f-129">Für `PerfCollect` ist die [`SYS_ADMIN`-Funktion](https://man7.org/linux/man-pages/man7/capabilities.7.html) (zur Ausführung des `perf`-Tools) erforderlich. Stellen Sie daher sicher, dass der Container [mit dieser Funktion gestartet wird](https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities).</span><span class="sxs-lookup"><span data-stu-id="9ab6f-129">`PerfCollect` requires the [`SYS_ADMIN` capability](https://man7.org/linux/man-pages/man7/capabilities.7.html) (in order to run the `perf` tool), so be sure the container is [started with that capability](https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities).</span></span>
2. <span data-ttu-id="9ab6f-130">Für `PerfCollect` müssen einige Umgebungsvariablen vor dem Start der App festgelegt werden, für die ein Profil erstellt werden soll.</span><span class="sxs-lookup"><span data-stu-id="9ab6f-130">`PerfCollect` requires some environment variables be set prior to the app it is profiling starting.</span></span> <span data-ttu-id="9ab6f-131">Diese können entweder in einem [Dockerfile](https://docs.docker.com/engine/reference/builder/#env) oder beim [Starten des Containers](https://docs.docker.com/engine/reference/run/#env-environment-variables) festgelegt werden.</span><span class="sxs-lookup"><span data-stu-id="9ab6f-131">These can be set either in a [Dockerfile](https://docs.docker.com/engine/reference/builder/#env) or when [starting the container](https://docs.docker.com/engine/reference/run/#env-environment-variables).</span></span> <span data-ttu-id="9ab6f-132">Da diese Variablen in normalen Produktionsumgebungen nicht festgelegt werden sollten, ist es üblich, sie beim Starten eines Containers für die Profilerstellung hinzuzufügen.</span><span class="sxs-lookup"><span data-stu-id="9ab6f-132">Because these variables shouldn't be set in normal production environments, it's common to just add them when starting a container that will be profiled.</span></span> <span data-ttu-id="9ab6f-133">Folgende zwei Variablen sind für PerfCollect erforderlich:</span><span class="sxs-lookup"><span data-stu-id="9ab6f-133">The two variables which PerfCollect requires are:</span></span>
    1. <span data-ttu-id="9ab6f-134">COMPlus_PerfMapEnabled=1</span><span class="sxs-lookup"><span data-stu-id="9ab6f-134">COMPlus_PerfMapEnabled=1</span></span>
    1. <span data-ttu-id="9ab6f-135">COMPlus_EnableEventLog=1</span><span class="sxs-lookup"><span data-stu-id="9ab6f-135">COMPlus_EnableEventLog=1</span></span>

### <a name="using-perfcollect-in-a-sidecar-container"></a><span data-ttu-id="9ab6f-136">Verwenden von `PerfCollect` in einem Sidecarcontainer</span><span class="sxs-lookup"><span data-stu-id="9ab6f-136">Using `PerfCollect` in a sidecar container</span></span>

<span data-ttu-id="9ab6f-137">Wenn Sie `PerfCollect` in einem Container ausführen möchten, um ein Profil für einen .NET Core-Prozess in einem anderen Container zu erstellen, ist die Vorgehensweise mit folgenden Ausnahmen nahezu identisch:</span><span class="sxs-lookup"><span data-stu-id="9ab6f-137">If you would like to run `PerfCollect` in one container to profile a .NET Core process in a different container, the experience is almost the same except for these differences:</span></span>

1. <span data-ttu-id="9ab6f-138">Die zuvor erwähnten Umgebungsvariablen („COMPlus_PerfMapEnabled“ und „COMPlus_EnableEventLog“) müssen für den Zielcontainer festgelegt werden (nicht für den, in dem `PerfCollect` ausgeführt wird).</span><span class="sxs-lookup"><span data-stu-id="9ab6f-138">The environment variables mentioned previously (COMPlus_PerfMapEnabled and COMPlus_EnableEventLog) must be set for the target container (not the one running `PerfCollect`).</span></span>
2. <span data-ttu-id="9ab6f-139">Der Container, in dem `PerfCollect` ausgeführt wird, muss über die `SYS_ADMIN`-Funktion verfügen (nicht der Zielcontainer).</span><span class="sxs-lookup"><span data-stu-id="9ab6f-139">The container running `PerfCollect` must have the `SYS_ADMIN` capability (not the target container).</span></span>
3. <span data-ttu-id="9ab6f-140">Die beiden Container müssen [einen Prozessnamespace gemeinsam verwenden](https://docs.docker.com/engine/reference/run/#pid-settings---pid).</span><span class="sxs-lookup"><span data-stu-id="9ab6f-140">The two containers must [share a process namespace](https://docs.docker.com/engine/reference/run/#pid-settings---pid).</span></span>

## <a name="using-createdump-in-a-container"></a><span data-ttu-id="9ab6f-141">Verwenden von `createdump` in einem Container</span><span class="sxs-lookup"><span data-stu-id="9ab6f-141">Using `createdump` in a container</span></span>

<span data-ttu-id="9ab6f-142">**Dieses Tool gilt für: ✔️** .NET Core 2.1 und neuere Versionen</span><span class="sxs-lookup"><span data-stu-id="9ab6f-142">**This tool applies to: ✔️** .NET Core 2.1 and later versions</span></span>

<span data-ttu-id="9ab6f-143">Als Alternative zu `dotnet-dump` kann [`createdump`](https://github.com/dotnet/runtime/blob/master/docs/design/coreclr/botr/xplat-minidump-generation.md) zum Erstellen von Kernspeicherabbildern unter Linux verwendet werden, die sowohl native als auch verwaltete Informationen enthalten.</span><span class="sxs-lookup"><span data-stu-id="9ab6f-143">An alternative to `dotnet-dump`, [`createdump`](https://github.com/dotnet/runtime/blob/master/docs/design/coreclr/botr/xplat-minidump-generation.md) can be used for creating core dumps on Linux containing both native and managed information.</span></span> <span data-ttu-id="9ab6f-144">Das Tool `createdump` wird mit der .NET Core-Runtime installiert und befindet sich bei libcoreclr.so (in der Regel unter „/usr/share/dotnet/shared/Microsoft.NETCore.App/[Version]“).</span><span class="sxs-lookup"><span data-stu-id="9ab6f-144">The `createdump` tool is installed with the .NET Core runtime and can be found next to libcoreclr.so (typically in "/usr/share/dotnet/shared/Microsoft.NETCore.App/[version]").</span></span> <span data-ttu-id="9ab6f-145">Das Tool funktioniert in einem Container genauso wie in nicht in Containern ausgeführten Linux-Umgebungen. Die einzige Ausnahme besteht darin, dass das Tool die [`SYS_PTRACE`-Funktion](https://man7.org/linux/man-pages/man7/capabilities.7.html) erfordert und der Docker-Container daher [mit dieser Funktion gestartet werden muss](https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities).</span><span class="sxs-lookup"><span data-stu-id="9ab6f-145">The tool works the same in a container as it does in non-containerized Linux environments with the single exception that the tool requires the [`SYS_PTRACE` capability](https://man7.org/linux/man-pages/man7/capabilities.7.html), so the Docker container must be [started with that capability](https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities).</span></span>

### <a name="using-createdump-in-a-sidecar-container"></a><span data-ttu-id="9ab6f-146">Verwenden von `createdump` in einem Sidecarcontainer</span><span class="sxs-lookup"><span data-stu-id="9ab6f-146">Using `createdump` in a sidecar container</span></span>

<span data-ttu-id="9ab6f-147">Wenn Sie mit `createdump` ein Speicherabbild über einen Prozess in einem anderen Container erstellen möchten, ist die Vorgehensweise mit folgenden Ausnahmen nahezu identisch:</span><span class="sxs-lookup"><span data-stu-id="9ab6f-147">If you would like to use `createdump` to create a dump from a process in a different container, the experience is almost the same except for these differences:</span></span>

1. <span data-ttu-id="9ab6f-148">Der Container, in dem `createdump` ausgeführt wird, muss über die `SYS_PTRACE`-Funktion verfügen (nicht der Zielcontainer).</span><span class="sxs-lookup"><span data-stu-id="9ab6f-148">The container running `createdump` must have the `SYS_PTRACE` capability (not the target container).</span></span>
2. <span data-ttu-id="9ab6f-149">Die beiden Container müssen [einen Prozessnamespace gemeinsam verwenden](https://docs.docker.com/engine/reference/run/#pid-settings---pid).</span><span class="sxs-lookup"><span data-stu-id="9ab6f-149">The two containers must [share a process namespace](https://docs.docker.com/engine/reference/run/#pid-settings---pid).</span></span>
