---
title: 'Vorgehensweise: Schreiben einer Parallel.For-Schleife mit threadlokalen Variablen'
description: Hier finden Sie ein Beispiel zum Schreiben einer Parallel.For-Schleife in .NET, die lokale Threadvariablen verwendet, die den Zustand bei jeder separaten Aufgabe in der Schleife speichern und abrufen.
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- parallel for loops, how to use local state
ms.assetid: 68384064-7ee7-41e2-90e3-71f00bde01bb
ms.openlocfilehash: f3adcfa98f4004f283b24bcd31dc243c18c2644c
ms.sourcegitcommit: d8020797a6657d0fbbdff362b80300815f682f94
ms.translationtype: HT
ms.contentlocale: de-DE
ms.lasthandoff: 11/24/2020
ms.locfileid: "95729368"
---
# <a name="how-to-write-a-parallelfor-loop-with-thread-local-variables"></a><span data-ttu-id="77149-103">Vorgehensweise: Schreiben einer Parallel.For-Schleife mit threadlokalen Variablen</span><span class="sxs-lookup"><span data-stu-id="77149-103">How to: Write a Parallel.For Loop with Thread-Local Variables</span></span>

<span data-ttu-id="77149-104">Dieses Beispiel zeigt, wie Sie threadlokale Variablen verwenden, um den Status in jeder separaten Aufgabe zu speichern und abzurufen, die von einer <xref:System.Threading.Tasks.Parallel.For%2A>-Schleife erstellt wird.</span><span class="sxs-lookup"><span data-stu-id="77149-104">This example shows how to use thread-local variables to store and retrieve state in each separate task that is created by a <xref:System.Threading.Tasks.Parallel.For%2A> loop.</span></span> <span data-ttu-id="77149-105">Durch die Verwendung von threadlokalen Daten können Sie den mit der Synchronisierung einer großen Anzahl von Zugriffen auf einen Freigabezustand verbundenen Mehraufwand vermeiden.</span><span class="sxs-lookup"><span data-stu-id="77149-105">By using thread-local data, you can avoid the overhead of synchronizing a large number of accesses to shared state.</span></span> <span data-ttu-id="77149-106">Statt an eine freigegebene Ressourcen in jeder Iteration zu schreiben, berechnen und speichern Sie den Wert, bis alle Iterationen für die Aufgabe abgeschlossen sind.</span><span class="sxs-lookup"><span data-stu-id="77149-106">Instead of writing to a shared resource on each iteration, you compute and store the value until all iterations for the task are complete.</span></span> <span data-ttu-id="77149-107">Sie können dann das endgültige Ergebnis einmal an die freigegebene Ressource schreiben oder sie an eine andere Methoden übergeben.</span><span class="sxs-lookup"><span data-stu-id="77149-107">You can then write the final result once to the shared resource, or pass it to another method.</span></span>  
  
## <a name="example"></a><span data-ttu-id="77149-108">Beispiel</span><span class="sxs-lookup"><span data-stu-id="77149-108">Example</span></span>  

 <span data-ttu-id="77149-109">Im folgenden Beispiel wird die <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29>-Methode aufgerufen, um die Summe der Werte in einem Array zu berechnen, das eine Million Elemente enthält.</span><span class="sxs-lookup"><span data-stu-id="77149-109">The following example calls the <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method to calculate the sum of the values in an array that contains one million elements.</span></span> <span data-ttu-id="77149-110">Der Wert für jedes Element entspricht dem Index.</span><span class="sxs-lookup"><span data-stu-id="77149-110">The value of each element is equal to its index.</span></span>  
  
 [!code-csharp[TPL_Parallel#05](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_parallel/cs/forandforeach_simple.cs#05)]
 [!code-vb[TPL_Parallel#05](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_parallel/vb/forwiththreadlocal.vb#05)]  
  
 <span data-ttu-id="77149-111">Die ersten zwei Parameter jeder <xref:System.Threading.Tasks.Parallel.For%2A>-Methode geben die Anfangs- und Enditerationswerte an.</span><span class="sxs-lookup"><span data-stu-id="77149-111">The first two parameters of every <xref:System.Threading.Tasks.Parallel.For%2A> method specify the beginning and ending iteration values.</span></span> <span data-ttu-id="77149-112">In dieser Überladung der Methode ist der dritte Parameter die Stelle, an der Sie Ihren lokalen Zustand initialisieren.</span><span class="sxs-lookup"><span data-stu-id="77149-112">In this overload of the method, the third parameter is where you initialize your local state.</span></span> <span data-ttu-id="77149-113">In diesem Kontext bedeutet lokaler Zustand eine Variable, deren Lebensdauer sich von dem Zeitpunkt gerade vor der ersten Iteration der Schleife im aktuellen Thread bis zu dem Zeitpunkt gerade nach der letzten Iteration erstreckt.</span><span class="sxs-lookup"><span data-stu-id="77149-113">In this context, local state means a variable whose lifetime extends from just before the first iteration of the loop on the current thread, to just after the last iteration.</span></span>  
  
 <span data-ttu-id="77149-114">Der dritte Parameter ist vom Typ <xref:System.Func%601>, wobei `TResult` der Variablentyp ist, der den threadlokalen Zustand speichert.</span><span class="sxs-lookup"><span data-stu-id="77149-114">The type of the third parameter is a <xref:System.Func%601> where `TResult` is the type of the variable that will store the thread-local state.</span></span> <span data-ttu-id="77149-115">Der Typ wird von dem generischen Typargument beim Aufrufen der generischen <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29>-Methode definiert, in diesem Fall <xref:System.Int64>.</span><span class="sxs-lookup"><span data-stu-id="77149-115">Its type is defined by the generic type argument supplied when calling the generic <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method, which in this case is <xref:System.Int64>.</span></span> <span data-ttu-id="77149-116">Das Typargument teilt dem Computer den Typ der temporären Variable mit, die verwendet wird, um den threadlokalen Zustand zu speichern.</span><span class="sxs-lookup"><span data-stu-id="77149-116">The type argument tells the compiler the type of the temporary variable that will be used to store the thread-local state.</span></span> <span data-ttu-id="77149-117">In diesem Beispiel initialisiert der Ausdruck `() => 0` (oder `Function() 0` in Visual Basic) die lokale Threadvariable auf Null.</span><span class="sxs-lookup"><span data-stu-id="77149-117">In this example, the expression `() => 0` (or `Function() 0` in Visual Basic) initializes the thread-local variable to zero.</span></span> <span data-ttu-id="77149-118">Wenn das generische Typargument ein Referenztyp oder ein benutzerdefinierter Werttyp ist, würde der Ausdruck wie folgt aussehen:</span><span class="sxs-lookup"><span data-stu-id="77149-118">If the generic type argument is a reference type or user-defined value type, the expression would look like this:</span></span>  
  
```csharp  
() => new MyClass()  
```  
  
```vb  
Function() new MyClass()  
```  
  
 <span data-ttu-id="77149-119">Der vierte Parameter definiert die Schleifenlogik.</span><span class="sxs-lookup"><span data-stu-id="77149-119">The fourth parameter defines the loop logic.</span></span> <span data-ttu-id="77149-120">Er muss ein Delegat oder Lambdaausdruck sein, dessen Signatur `Func<int, ParallelLoopState, long, long>` in C# oder `Func(Of Integer, ParallelLoopState, Long, Long)` in Visual Basic ist.</span><span class="sxs-lookup"><span data-stu-id="77149-120">It must be a delegate or lambda expression whose signature is `Func<int, ParallelLoopState, long, long>` in C# or `Func(Of Integer, ParallelLoopState, Long, Long)` in Visual Basic.</span></span> <span data-ttu-id="77149-121">Der erste Parameter ist der Wert des Schleifenzählers für diese Iteration der Schleife.</span><span class="sxs-lookup"><span data-stu-id="77149-121">The first parameter is the value of the loop counter for that iteration of the loop.</span></span> <span data-ttu-id="77149-122">Der zweite ist ein <xref:System.Threading.Tasks.ParallelLoopState>-Objekt, das verwendet werden kann, um die Schleife zu unterbrechen. Dieses Objekt wird von der <xref:System.Threading.Tasks.Parallel>-Klasse für jedes Auftreten der Schleife bereitgestellt.</span><span class="sxs-lookup"><span data-stu-id="77149-122">The second is a <xref:System.Threading.Tasks.ParallelLoopState> object that can be used to break out of the loop; this object is provided by the <xref:System.Threading.Tasks.Parallel> class to each occurrence of the loop.</span></span> <span data-ttu-id="77149-123">Der dritte Parameter ist die lokale Threadvariable.</span><span class="sxs-lookup"><span data-stu-id="77149-123">The third parameter is the thread-local variable.</span></span> <span data-ttu-id="77149-124">Der letzte Parameter ist der Rückgabetyp.</span><span class="sxs-lookup"><span data-stu-id="77149-124">The last parameter is the return type.</span></span> <span data-ttu-id="77149-125">In diesem Fall ist der Typ <xref:System.Int64>, weil wir diesen Typ im <xref:System.Threading.Tasks.Parallel.For%2A>-Typargument angegeben haben.</span><span class="sxs-lookup"><span data-stu-id="77149-125">In this case, the type is <xref:System.Int64> because that is the type we specified in the <xref:System.Threading.Tasks.Parallel.For%2A> type argument.</span></span> <span data-ttu-id="77149-126">Diese Variable hat den Namen `subtotal` und wird vom Lambda-Ausdruck zurückgegeben.</span><span class="sxs-lookup"><span data-stu-id="77149-126">That variable is named `subtotal` and is returned by the lambda expression.</span></span> <span data-ttu-id="77149-127">Die Rückgabewert wird verwendet, um `subtotal` in jeder folgenden Iteration der Schleife zu initialisieren.</span><span class="sxs-lookup"><span data-stu-id="77149-127">The return value is used to initialize `subtotal` on each subsequent iteration of the loop.</span></span> <span data-ttu-id="77149-128">Sie können sich diesen letzten Parameter auch als einen Wert vorstellen, der an jede Iteration und dann an den `localFinally`-Delegaten übergeben wird, wenn die letzte Iteration abgeschlossen ist.</span><span class="sxs-lookup"><span data-stu-id="77149-128">You can also think of this last parameter as a value that is passed to each iteration, and then passed to the `localFinally` delegate when the last iteration is complete.</span></span>  
  
 <span data-ttu-id="77149-129">Der fünfte Parameter definiert die Methode, die einmal aufgerufen wird, nachdem alle Iterationen in einem bestimmten Thread abgeschlossen wurden.</span><span class="sxs-lookup"><span data-stu-id="77149-129">The fifth parameter defines the method that is called once, after all the iterations on a particular thread have completed.</span></span> <span data-ttu-id="77149-130">Der Typ des Eingabearguments entspricht erneut dem Typargument der <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29>-Methode und dem vom Text-Lambda-Ausdruck zurückgegebenen Typ.</span><span class="sxs-lookup"><span data-stu-id="77149-130">The type of the input argument again corresponds to the type argument of the <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method and the type returned by the body lambda expression.</span></span> <span data-ttu-id="77149-131">In diesem Beispiel wird der Wert zu einer Variable im Gültigkeitsbereich einer Klasse auf eine threadsichere Weise hinzugefügt, indem die <xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType>-Methode aufgerufen wird.</span><span class="sxs-lookup"><span data-stu-id="77149-131">In this example, the value is added to a variable at class scope in a thread safe way by calling the <xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="77149-132">Durch die Verwendung einer lokalen Threadvariable haben wir das Schreiben an diese Klassenvariable in jeder Iteration der Schleife vermieden.</span><span class="sxs-lookup"><span data-stu-id="77149-132">By using a thread-local variable, we have avoided writing to this class variable on every iteration of the loop.</span></span>  
  
 <span data-ttu-id="77149-133">Weitere Informationen zur Verwendung von Lambdaausdrücken finden Sie unter [Lambdaausdrücke in PLINQ und TPL](lambda-expressions-in-plinq-and-tpl.md).</span><span class="sxs-lookup"><span data-stu-id="77149-133">For more information about how to use lambda expressions, see [Lambda Expressions in PLINQ and TPL](lambda-expressions-in-plinq-and-tpl.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="77149-134">Siehe auch</span><span class="sxs-lookup"><span data-stu-id="77149-134">See also</span></span>

- [<span data-ttu-id="77149-135">Datenparallelität</span><span class="sxs-lookup"><span data-stu-id="77149-135">Data Parallelism</span></span>](data-parallelism-task-parallel-library.md)
- [<span data-ttu-id="77149-136">Parallele Programmierung</span><span class="sxs-lookup"><span data-stu-id="77149-136">Parallel Programming</span></span>](index.md)
- [<span data-ttu-id="77149-137">Task Parallel Library (TPL)</span><span class="sxs-lookup"><span data-stu-id="77149-137">Task Parallel Library (TPL)</span></span>](task-parallel-library-tpl.md)
- [<span data-ttu-id="77149-138">Lambdaausdrücke in PLINQ und TPL</span><span class="sxs-lookup"><span data-stu-id="77149-138">Lambda Expressions in PLINQ and TPL</span></span>](lambda-expressions-in-plinq-and-tpl.md)
