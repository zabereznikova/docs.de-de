---
title: Schreiben von sicherem dynamischen SQL in SQL Server
ms.custom: 
ms.date: 03/30/2017
ms.prod: .net-framework
ms.reviewer: 
ms.suite: 
ms.technology: dotnet-ado
ms.tgt_pltfrm: 
ms.topic: article
ms.assetid: df5512b0-c249-40d2-82f9-f9a2ce6665bc
caps.latest.revision: "9"
author: douglaslMS
ms.author: douglasl
manager: craigg
ms.workload: dotnet
ms.openlocfilehash: 41c396bf2101e54adb1608f938c702ff7663cb1d
ms.sourcegitcommit: ed26cfef4e18f6d93ab822d8c29f902cff3519d1
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 01/17/2018
---
# <a name="writing-secure-dynamic-sql-in-sql-server"></a><span data-ttu-id="a1e30-102">Schreiben von sicherem dynamischen SQL in SQL Server</span><span class="sxs-lookup"><span data-stu-id="a1e30-102">Writing Secure Dynamic SQL in SQL Server</span></span>
<span data-ttu-id="a1e30-103">Die Einschleusung von SQL-Befehlen (SQL Injection-Angriff) ist eine Möglichkeit, Anwendungen anzugreifen. Dabei werden anstelle einer gültigen Eingabe Transact-SQL-Anweisungen in den Code eingeschleust.</span><span class="sxs-lookup"><span data-stu-id="a1e30-103">SQL Injection is the process by which a malicious user enters Transact-SQL statements instead of valid input.</span></span> <span data-ttu-id="a1e30-104">Wenn die Eingabe direkt und ohne Validierung an den Server weitergeleitet wird und die Anwendung den eingeschleusten Code ausführt, können Daten beschädigt oder sogar zerstört werden.</span><span class="sxs-lookup"><span data-stu-id="a1e30-104">If the input is passed directly to the server without being validated and if the application inadvertently executes the injected code, the attack has the potential to damage or destroy data.</span></span>  
  
 <span data-ttu-id="a1e30-105">Alle Prozeduren, die SQL-Anweisungen konstruieren, sollten auf Schwachstellen überprüft werden, die die Einschleusung von SQL-Befehlen ermöglichen, da SQL Server alle syntaktisch gültigen Abfragen ungeprüft ausführt.</span><span class="sxs-lookup"><span data-stu-id="a1e30-105">Any procedure that constructs SQL statements should be reviewed for injection vulnerabilities because SQL Server will execute all syntactically valid queries that it receives.</span></span> <span data-ttu-id="a1e30-106">Selbst parametrisierte Daten können von einem geschickten und entschlossenen Angreifer manipuliert werden.</span><span class="sxs-lookup"><span data-stu-id="a1e30-106">Even parameterized data can be manipulated by a skilled and determined attacker.</span></span> <span data-ttu-id="a1e30-107">Bei Verwendung von dynamischem SQL sollten Sie Ihre Befehle unbedingt parametrisieren und auf keinen Fall Parameterwerte direkt in die Abfragezeichenfolge aufnehmen.</span><span class="sxs-lookup"><span data-stu-id="a1e30-107">If you use dynamic SQL, be sure to parameterize your commands, and never include parameter values directly into the query string.</span></span>  
  
## <a name="anatomy-of-a-sql-injection-attack"></a><span data-ttu-id="a1e30-108">Anatomie eines SQL Injection-Angriffs</span><span class="sxs-lookup"><span data-stu-id="a1e30-108">Anatomy of a SQL Injection Attack</span></span>  
 <span data-ttu-id="a1e30-109">Beim Einschleusen wird eine Textzeichenfolge vorzeitig beendet, und es wird ein neuer Befehl angefügt.</span><span class="sxs-lookup"><span data-stu-id="a1e30-109">The injection process works by prematurely terminating a text string and appending a new command.</span></span> <span data-ttu-id="a1e30-110">Da der eingeschleuste Befehl zusätzliche Zeichenfolgen enthalten kann, die vor dessen Ausführung angefügt wurden, beendet der Angreifer die eingeschleuste Zeichenfolge mit einer Kommentarmarkierung ("--").</span><span class="sxs-lookup"><span data-stu-id="a1e30-110">Because the inserted command may have additional strings appended to it before it is executed, the malefactor terminates the injected string with a comment mark "--".</span></span> <span data-ttu-id="a1e30-111">Der Text, der dieser Kommentarmarkierung folgt, wird bei der Ausführung ignoriert.</span><span class="sxs-lookup"><span data-stu-id="a1e30-111">Subsequent text is ignored at execution time.</span></span> <span data-ttu-id="a1e30-112">Durch Eingabe eines Semikolons (;) als Trennzeichen können auch mehrere Befehle eingeschleust werden.</span><span class="sxs-lookup"><span data-stu-id="a1e30-112">Multiple commands can be inserted using a semicolon (;) delimiter.</span></span>  
  
 <span data-ttu-id="a1e30-113">Sofern der SQL-Code syntaktisch korrekt ist, kann die Manipulation nicht programmgesteuert erkannt werden.</span><span class="sxs-lookup"><span data-stu-id="a1e30-113">As long as injected SQL code is syntactically correct, tampering cannot be detected programmatically.</span></span> <span data-ttu-id="a1e30-114">Sie müssen daher alle Benutzereingaben validieren und Code sorgfältig prüfen, der konstruierte SQL-Befehle im verwendeten Server ausführt.</span><span class="sxs-lookup"><span data-stu-id="a1e30-114">Therefore, you must validate all user input and carefully review code that executes constructed SQL commands in the server that you are using.</span></span> <span data-ttu-id="a1e30-115">Verketten Sie nie Benutzereingaben, die nicht validiert wurden.</span><span class="sxs-lookup"><span data-stu-id="a1e30-115">Never concatenate user input that is not validated.</span></span> <span data-ttu-id="a1e30-116">Die Zeichenfolgenverkettung ist der primäre Ansatzpunkt für die Einschleusung von Skriptcode.</span><span class="sxs-lookup"><span data-stu-id="a1e30-116">String concatenation is the primary point of entry for script injection.</span></span>  
  
 <span data-ttu-id="a1e30-117">Beachten Sie Folgendes:</span><span class="sxs-lookup"><span data-stu-id="a1e30-117">Here are some helpful guidelines:</span></span>  
  
-   <span data-ttu-id="a1e30-118">Erstellen Sie keine Transact-SQL-Anweisungen direkt aus Benutzereingaben. Validieren Sie Benutzereingaben mit gespeicherten Prozeduren.</span><span class="sxs-lookup"><span data-stu-id="a1e30-118">Never build Transact-SQL statements directly from user input; use stored procedures to validate user input.</span></span>  
  
-   <span data-ttu-id="a1e30-119">Validieren Sie Benutzereingaben durch Prüfen des Typs, der Länge, des Formats und des Bereichs.</span><span class="sxs-lookup"><span data-stu-id="a1e30-119">Validate user input by testing type, length, format, and range.</span></span> <span data-ttu-id="a1e30-120">Verwenden Sie die Transact-SQL-QUOTENAME()-Funktion, um Systemnamen zu maskieren, oder die REPLACE()-Funktion, um Zeichen in einer Zeichenfolge zu maskieren.</span><span class="sxs-lookup"><span data-stu-id="a1e30-120">Use the Transact-SQL QUOTENAME() function to escape system names or the REPLACE() function to escape any character in a string.</span></span>  
  
-   <span data-ttu-id="a1e30-121">Implementieren Sie für jede Anwendungsebene mehrere Validierungsschichten.</span><span class="sxs-lookup"><span data-stu-id="a1e30-121">Implement multiple layers of validation in each tier of your application.</span></span>  
  
-   <span data-ttu-id="a1e30-122">Prüfen Sie die Größe und den Datentyp der Eingabe, und sorgen Sie für die Einhaltung der festgelegten Grenzwerte.</span><span class="sxs-lookup"><span data-stu-id="a1e30-122">Test the size and data type of input and enforce appropriate limits.</span></span> <span data-ttu-id="a1e30-123">Dies kann helfen, vorsätzliche Pufferüberläufe zu verhindern.</span><span class="sxs-lookup"><span data-stu-id="a1e30-123">This can help prevent deliberate buffer overruns.</span></span>  
  
-   <span data-ttu-id="a1e30-124">Prüfen Sie den Inhalt von Zeichenfolgenvariablen, und akzeptieren Sie nur erwartete Werte.</span><span class="sxs-lookup"><span data-stu-id="a1e30-124">Test the content of string variables and accept only expected values.</span></span> <span data-ttu-id="a1e30-125">Lehnen Sie Einträge ab, die Binärdaten, Maskierungssequenzen und Kommentarzeichen enthalten.</span><span class="sxs-lookup"><span data-stu-id="a1e30-125">Reject entries that contain binary data, escape sequences, and comment characters.</span></span>  
  
-   <span data-ttu-id="a1e30-126">Validieren Sie beim Arbeiten mit XML-Dokumenten alle eingegebenen Daten anhand ihres Schemas.</span><span class="sxs-lookup"><span data-stu-id="a1e30-126">When you are working with XML documents, validate all data against its schema as it is entered.</span></span>  
  
-   <span data-ttu-id="a1e30-127">Sorgen Sie dafür, dass in Umgebungen mit mehreren Ebenen alle Daten vor dem Eintritt in die vertrauenswürdige Zone validiert werden.</span><span class="sxs-lookup"><span data-stu-id="a1e30-127">In multi-tiered environments, all data should be validated before admission to the trusted zone.</span></span>  
  
-   <span data-ttu-id="a1e30-128">In Feldern, aus denen Dateinamen konstruiert werden können, dürfen die folgenden Zeichenfolgen nicht akzeptiert werden: AUX, CLOCK$, COM1 bis COM8, CON, CONFIG$, LPT1 bis LPT8, NUL und PRN.</span><span class="sxs-lookup"><span data-stu-id="a1e30-128">Do not accept the following strings in fields from which file names can be constructed: AUX, CLOCK$, COM1 through COM8, CON, CONFIG$, LPT1 through LPT8, NUL, and PRN.</span></span>  
  
-   <span data-ttu-id="a1e30-129">Verwenden Sie für die Typprüfung und die Längenvalidierung <xref:System.Data.SqlClient.SqlParameter>-Objekte mit gespeicherten Prozeduren und Befehlen.</span><span class="sxs-lookup"><span data-stu-id="a1e30-129">Use <xref:System.Data.SqlClient.SqlParameter> objects with stored procedures and commands to provide type checking and length validation.</span></span>  
  
-   <span data-ttu-id="a1e30-130">Verwenden Sie im Clientcode <xref:System.Text.RegularExpressions.Regex>-Ausdrücke, um ungültige Zeichen herauszufiltern.</span><span class="sxs-lookup"><span data-stu-id="a1e30-130">Use <xref:System.Text.RegularExpressions.Regex> expressions in client code to filter invalid characters.</span></span>  
  
## <a name="dynamic-sql-strategies"></a><span data-ttu-id="a1e30-131">Strategien bei der Verwendung von dynamischem SQL</span><span class="sxs-lookup"><span data-stu-id="a1e30-131">Dynamic SQL Strategies</span></span>  
 <span data-ttu-id="a1e30-132">Beim Ausführen dynamisch erstellter SQL-Anweisungen in Ihrem prozeduralen Code wird die Besitzkette unterbrochen, sodass SQL Server die Berechtigungen des Aufrufers anhand der Objekte prüfen muss, auf die die dynamischen SQL-Anweisungen zugreifen.</span><span class="sxs-lookup"><span data-stu-id="a1e30-132">Executing dynamically created SQL statements in your procedural code breaks the ownership chain, causing SQL Server to check the permissions of the caller against the objects being accessed by the dynamic SQL.</span></span>  
  
 <span data-ttu-id="a1e30-133">SQL Server verfügt über Methoden, um Benutzern mithilfe von gespeicherten Prozeduren und benutzerdefinierten Funktionen, die dynamischen SQL-Code ausführen, den Zugriff auf Daten zu gewähren.</span><span class="sxs-lookup"><span data-stu-id="a1e30-133">SQL Server has methods for granting users access to data using stored procedures and user-defined functions that execute dynamic SQL.</span></span>  
  
-   <span data-ttu-id="a1e30-134">Verwenden des Identitätswechsels mit der Transact-SQL EXECUTE AS-Klausel, wie in beschrieben [Anpassen von Berechtigungen durch Identitätswechsel in SQL Server](../../../../../docs/framework/data/adonet/sql/customizing-permissions-with-impersonation-in-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="a1e30-134">Using impersonation with the Transact-SQL EXECUTE AS clause, as described in [Customizing Permissions with Impersonation in SQL Server](../../../../../docs/framework/data/adonet/sql/customizing-permissions-with-impersonation-in-sql-server.md).</span></span>  
  
-   <span data-ttu-id="a1e30-135">Signieren von gespeicherten Prozeduren mit Zertifikaten, wie in beschrieben [Signieren von gespeicherten Prozeduren in SQL Server](../../../../../docs/framework/data/adonet/sql/signing-stored-procedures-in-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="a1e30-135">Signing stored procedures with certificates, as described in [Signing Stored Procedures in SQL Server](../../../../../docs/framework/data/adonet/sql/signing-stored-procedures-in-sql-server.md).</span></span>  
  
### <a name="execute-as"></a><span data-ttu-id="a1e30-136">EXECUTE AS</span><span class="sxs-lookup"><span data-stu-id="a1e30-136">EXECUTE AS</span></span>  
 <span data-ttu-id="a1e30-137">Die EXECUTE AS-Klausel ersetzt die Berechtigungen des Aufrufers durch die Berechtigungen des in der EXECUTE AS-Klausel angegebenen Benutzers.</span><span class="sxs-lookup"><span data-stu-id="a1e30-137">The EXECUTE AS clause replaces the permissions of the caller with that of the user specified in the EXECUTE AS clause.</span></span> <span data-ttu-id="a1e30-138">Geschachtelte gespeicherte Prozeduren oder Trigger werden im Sicherheitskontext des Proxybenutzers ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="a1e30-138">Nested stored procedures or triggers execute under the security context of the proxy user.</span></span> <span data-ttu-id="a1e30-139">Bei Anwendungen, die sich auf zeilenbasierte Sicherheit stützen oder eine Überwachung verlangen, kann dies zum Abbruch führen.</span><span class="sxs-lookup"><span data-stu-id="a1e30-139">This can break applications that rely on row-level security or require auditing.</span></span> <span data-ttu-id="a1e30-140">Einige Funktionen, die die Identität des Benutzers zurückgeben, geben den in der EXECUTE AS-Klausel angegebenen Benutzer und nicht den ursprünglichen Aufrufer zurück.</span><span class="sxs-lookup"><span data-stu-id="a1e30-140">Some functions that return the identity of the user return the user specified in the EXECUTE AS clause, not the original caller.</span></span> <span data-ttu-id="a1e30-141">Der Ausführungskontext geht erst dann wieder auf den ursprünglichen Aufrufer über, wenn die Ausführung der Prozedur abgeschlossen wurde oder wenn eine REVERT-Anweisung ausgegeben wird.</span><span class="sxs-lookup"><span data-stu-id="a1e30-141">Execution context is reverted to the original caller only after execution of the procedure or when a REVERT statement is issued.</span></span>  
  
### <a name="certificate-signing"></a><span data-ttu-id="a1e30-142">Signieren mit Zertifikaten</span><span class="sxs-lookup"><span data-stu-id="a1e30-142">Certificate Signing</span></span>  
 <span data-ttu-id="a1e30-143">Bei der Ausführung einer mit einem Zertifikat signierten gespeicherten Prozedur werden die dem Zertifikatsbenutzer gewährten Berechtigungen mit den Berechtigungen des Aufrufers zusammengeführt.</span><span class="sxs-lookup"><span data-stu-id="a1e30-143">When a stored procedure that has been signed with a certificate executes, the permissions granted to the certificate user are merged with those of the caller.</span></span> <span data-ttu-id="a1e30-144">Der Ausführungskontext bleibt identisch. Der Zertifikatsbenutzer nimmt nicht die Identität des Aufrufers an.</span><span class="sxs-lookup"><span data-stu-id="a1e30-144">The execution context remains the same; the certificate user does not impersonate the caller.</span></span> <span data-ttu-id="a1e30-145">Für das Signieren gespeicherter Prozeduren müssen verschiedene Schritte ausgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="a1e30-145">Signing stored procedures requires several steps to implement.</span></span> <span data-ttu-id="a1e30-146">Jedes Mal, wenn die Prozedur geändert wird, muss sie neu signiert werden.</span><span class="sxs-lookup"><span data-stu-id="a1e30-146">Each time the procedure is modified, it must be re-signed.</span></span>  
  
### <a name="cross-database-access"></a><span data-ttu-id="a1e30-147">Datenbankübergreifender Zugriff</span><span class="sxs-lookup"><span data-stu-id="a1e30-147">Cross Database Access</span></span>  
 <span data-ttu-id="a1e30-148">Bei der Ausführung dynamisch erstellter SQL-Anweisungen funktioniert die datenbankübergreifende Besitzverkettung nicht.</span><span class="sxs-lookup"><span data-stu-id="a1e30-148">Cross-database ownership chaining does not work in cases where dynamically created SQL statements are executed.</span></span> <span data-ttu-id="a1e30-149">Dieses Problem können Sie in [!INCLUDE[ssNoVersion](../../../../../includes/ssnoversion-md.md)] umgehen, indem Sie eine gespeicherte Prozedur erstellen, die auf die Daten in einer anderen Datenbank zugreift, und die Prozedur mit einem Zertifikat signieren, das in beiden Datenbanken vorhanden ist.</span><span class="sxs-lookup"><span data-stu-id="a1e30-149">You can work around this in [!INCLUDE[ssNoVersion](../../../../../includes/ssnoversion-md.md)] by creating a stored procedure that accesses data in another database and signing the procedure with a certificate that exists in both databases.</span></span> <span data-ttu-id="a1e30-150">Die Benutzer können dann auf die von der Prozedur verwendeten Datenbankressourcen zugreifen, ohne dass ihnen Zugriffsrechte für die Datenbank oder andere Berechtigungen erteilt werden müssen.</span><span class="sxs-lookup"><span data-stu-id="a1e30-150">This gives users access to the database resources used by the procedure without granting them database access or permissions.</span></span>  
  
## <a name="external-resources"></a><span data-ttu-id="a1e30-151">Externe Ressourcen</span><span class="sxs-lookup"><span data-stu-id="a1e30-151">External Resources</span></span>  
 <span data-ttu-id="a1e30-152">Weitere Informationen finden Sie in den folgenden Ressourcen.</span><span class="sxs-lookup"><span data-stu-id="a1e30-152">For more information, see the following resources.</span></span>  
  
|<span data-ttu-id="a1e30-153">Ressource</span><span class="sxs-lookup"><span data-stu-id="a1e30-153">Resource</span></span>|<span data-ttu-id="a1e30-154">Beschreibung</span><span class="sxs-lookup"><span data-stu-id="a1e30-154">Description</span></span>|  
|--------------|-----------------|  
|<span data-ttu-id="a1e30-155">[Gespeicherte Prozeduren](http://go.microsoft.com/fwlink/?LinkId=98233) und [SQL Injection](http://go.microsoft.com/fwlink/?LinkId=98234) in SQL Server-Onlinedokumentation</span><span class="sxs-lookup"><span data-stu-id="a1e30-155">[Stored Procedures](http://go.microsoft.com/fwlink/?LinkId=98233) and [SQL Injection](http://go.microsoft.com/fwlink/?LinkId=98234) in SQL Server Books Online</span></span>|<span data-ttu-id="a1e30-156">In den Themen wird beschrieben, wie Sie gespeicherte Prozeduren erstellen und wie die Einschleusung von SQL-Befehlen bei SQL Injection-Angriffen funktioniert.</span><span class="sxs-lookup"><span data-stu-id="a1e30-156">Topics describe how to create stored procedures and how SQL Injection works.</span></span>|  
|<span data-ttu-id="a1e30-157">[Neue SQL-Kürzungsangriffe und zum Vermeiden](http://msdn.microsoft.com/msdnmag/issues/06/11/SQLSecurity/) im MSDN Magazin.</span><span class="sxs-lookup"><span data-stu-id="a1e30-157">[New SQL Truncation Attacks And How To Avoid Them](http://msdn.microsoft.com/msdnmag/issues/06/11/SQLSecurity/) in MSDN Magazine.</span></span>|<span data-ttu-id="a1e30-158">Beschreibt den Umgang mit Begrenzern und Bezeichnern, Praktiken zur Einschleusung von SQL-Befehlen (SQL Injection) sowie Angriffe, bei denen Codeänderungen durch Abschneidung vorgenommen werden.</span><span class="sxs-lookup"><span data-stu-id="a1e30-158">Describes how to delimit characters and strings, SQL injection, and modification by  truncation attacks.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="a1e30-159">Siehe auch</span><span class="sxs-lookup"><span data-stu-id="a1e30-159">See Also</span></span>  
 [<span data-ttu-id="a1e30-160">Sichern von ADO.NET-Anwendungen</span><span class="sxs-lookup"><span data-stu-id="a1e30-160">Securing ADO.NET Applications</span></span>](../../../../../docs/framework/data/adonet/securing-ado-net-applications.md)  
 [<span data-ttu-id="a1e30-161">Übersicht über die SQL Server-Sicherheit</span><span class="sxs-lookup"><span data-stu-id="a1e30-161">Overview of SQL Server Security</span></span>](../../../../../docs/framework/data/adonet/sql/overview-of-sql-server-security.md)  
 [<span data-ttu-id="a1e30-162">Anwendungssicherheitsszenarios in SQL Server</span><span class="sxs-lookup"><span data-stu-id="a1e30-162">Application Security Scenarios in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/application-security-scenarios-in-sql-server.md)  
 [<span data-ttu-id="a1e30-163">Verwalten von Berechtigungen mit gespeicherten Prozeduren in SQL Server</span><span class="sxs-lookup"><span data-stu-id="a1e30-163">Managing Permissions with Stored Procedures in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/managing-permissions-with-stored-procedures-in-sql-server.md)  
 [<span data-ttu-id="a1e30-164">Signieren von gespeicherten Prozeduren in SQL Server</span><span class="sxs-lookup"><span data-stu-id="a1e30-164">Signing Stored Procedures in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/signing-stored-procedures-in-sql-server.md)  
 [<span data-ttu-id="a1e30-165">Anpassen von Berechtigungen durch Identitätswechsel in SQL Server</span><span class="sxs-lookup"><span data-stu-id="a1e30-165">Customizing Permissions with Impersonation in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/customizing-permissions-with-impersonation-in-sql-server.md)  
 [<span data-ttu-id="a1e30-166">ADO.NET Managed Provider und DataSet Developer Center</span><span class="sxs-lookup"><span data-stu-id="a1e30-166">ADO.NET Managed Providers and DataSet Developer Center</span></span>](http://go.microsoft.com/fwlink/?LinkId=217917)
