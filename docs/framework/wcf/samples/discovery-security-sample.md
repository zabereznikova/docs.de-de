---
title: Beispiel für Ermittlungssicherheit
ms.date: 03/30/2017
ms.assetid: b8db01f4-b4a1-43fe-8e31-26d4e9304a65
ms.openlocfilehash: 0957e8ddaee99e60b205c92319dc2c61e2ab007a
ms.sourcegitcommit: bc293b14af795e0e999e3304dd40c0222cf2ffe4
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 11/26/2020
ms.locfileid: "96292635"
---
# <a name="discovery-security-sample"></a><span data-ttu-id="6a2d3-102">Beispiel für Ermittlungssicherheit</span><span class="sxs-lookup"><span data-stu-id="6a2d3-102">Discovery Security Sample</span></span>

<span data-ttu-id="6a2d3-103">Die Discovery-Spezifikation erfordert nicht, dass Endpunkte, die am Suchvorgang beteiligt sind, sicher sein müssen.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-103">The Discovery specification does not require that endpoints that participate in the discovery process to be secure.</span></span> <span data-ttu-id="6a2d3-104">Die Erweiterung der Sicherheit von Suchmeldungen mindert das Risiko für verschiedene Angriffe (Meldungsänderung, Denial of Service, Wiederholung, Spoofing).</span><span class="sxs-lookup"><span data-stu-id="6a2d3-104">Enhancing the discovery messages with security mitigates various types of attacks (message alteration, denial of service, replay, spoofing).</span></span> <span data-ttu-id="6a2d3-105">In diesem Beispiel werden benutzerdefinierte Kanäle implementiert, die Meldungssignaturen mit dem kompakten Signaturformat berechnen und verifizieren. (Dies wird in Abschnitt 8.2 der WS-Discovery-Spezifikation beschrieben.)</span><span class="sxs-lookup"><span data-stu-id="6a2d3-105">This sample implements custom channels that compute and verify message signatures using the compact signature format (described in Section 8.2 of the WS-Discovery specification).</span></span> <span data-ttu-id="6a2d3-106">Das Beispiel unterstützt sowohl die [2005 Discovery-Spezifikation](http://specs.xmlsoap.org/ws/2005/04/discovery/ws-discovery.pdf) als auch die [1,1-Version](http://docs.oasis-open.org/ws-dd/discovery/1.1/cs-01/wsdd-discovery-1.1-spec-cs-01.pdf).</span><span class="sxs-lookup"><span data-stu-id="6a2d3-106">The sample supports both the [2005 Discovery specification](http://specs.xmlsoap.org/ws/2005/04/discovery/ws-discovery.pdf) and the [1.1 version](http://docs.oasis-open.org/ws-dd/discovery/1.1/cs-01/wsdd-discovery-1.1-spec-cs-01.pdf).</span></span>  
  
 <span data-ttu-id="6a2d3-107">Der benutzerdefinierte Kanal wird an die oberste Stelle des vorhandenen Kanalstapels für Ermittlungs- und Ankündigungsendpunkte gesetzt.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-107">The custom channel is applied on top of the existing channel stack for Discovery and Announcement endpoints.</span></span> <span data-ttu-id="6a2d3-108">Auf diese Weise wird ein Signaturheader für jede gesendete Meldung übernommen.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-108">This way, a signature header is applied for every message sent.</span></span> <span data-ttu-id="6a2d3-109">Die Signatur wird im Hinblick auf empfangene Meldungen überprüft. Wenn die Signatur nicht übereinstimmt oder die Meldungen nicht über eine Signatur verfügen, werden sie verworfen.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-109">The signature is verified on received messages and when it does not match or when the messages do not have a signature, the messages are dropped.</span></span> <span data-ttu-id="6a2d3-110">Im Beispiel werden Zertifikate verwendet, um Meldungen zu signieren und zu überprüfen.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-110">To sign and verify messages, the sample uses certificates.</span></span>  
  
## <a name="discussion"></a><span data-ttu-id="6a2d3-111">Diskussion</span><span class="sxs-lookup"><span data-stu-id="6a2d3-111">Discussion</span></span>  

 <span data-ttu-id="6a2d3-112">WCF ist erweiterbar und ermöglicht den Benutzern die Möglichkeit, Kanäle wie gewünscht anzupassen.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-112">WCF is extensible and allows users the possibility to customize channels as desired.</span></span> <span data-ttu-id="6a2d3-113">Im Beispiel wird ein sicheres Ermittlungsbindungselement implementiert, mit dem sichere Kanäle erstellt werden.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-113">The sample implements a discovery secure binding element that builds secure channels.</span></span> <span data-ttu-id="6a2d3-114">Die sicheren Kanäle wenden Meldungssignaturen an und überprüfen diese. Sie werden an die oberste Stelle des aktuellen Stapels übernommen.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-114">The secure channels apply and verify message signatures and are applied on top of the current stack.</span></span>  
  
 <span data-ttu-id="6a2d3-115">Mit dem sicheren Bindungselement werden sichere Kanalfactorys und Kanallistener erstellt.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-115">The secure binding element builds secure channel factories and channel listeners.</span></span>  
  
## <a name="secure-channel-factory"></a><span data-ttu-id="6a2d3-116">Sichere Kanalfactory</span><span class="sxs-lookup"><span data-stu-id="6a2d3-116">Secure Channel Factory</span></span>  

 <span data-ttu-id="6a2d3-117">Von der sicheren Kanalfactory werden Ausgabe- oder Duplexkanäle erstellt, mit denen Nachrichtenheadern eine kompakte Signatur hinzugefügt wird.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-117">The secure channel factory creates output or duplex channels that add a compact signature to message headers.</span></span> <span data-ttu-id="6a2d3-118">Damit Meldungen möglichst klein bleiben, wird das kompakte Signaturformat verwendet.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-118">To keep messages as small as possible the compact signature format is used.</span></span> <span data-ttu-id="6a2d3-119">Im folgenden Beispiel wird die Struktur einer kompakten Signatur dargestellt.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-119">The structure of a compact signature is shown in the following example.</span></span>  
  
```xml  
<d:Security ... >
  [<d:Sig Scheme="xs:anyURI"
         [KeyId="xs:base64Binary"]?  
          Refs="..."  
         [PrefixList]="xs:NMTOKENS"
          Sig="xs:base64Binary"
          ... />]?  
  ...
</d:Security>  
```  
  
> [!NOTE]
> <span data-ttu-id="6a2d3-120">Die `PrefixList` wurde dem Protokoll der Discovery-Version 2008 hinzugefügt.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-120">The `PrefixList` was added in the 2008 Discovery version protocol.</span></span>  
  
 <span data-ttu-id="6a2d3-121">Im Beispiel werden die erweiterten Signaturelemente bestimmt, um die Signatur zu berechnen.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-121">To compute the signature, the sample determines the expanded signature items.</span></span> <span data-ttu-id="6a2d3-122">Wie in der WS-Discovery-Spezifikation gefordert, wird eine XML-Signatur (`SignedInfo`) mit dem `ds`-Namespacepräfix erstellt.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-122">An XML signature (`SignedInfo`) is created, using the `ds` namespace prefix, as required by the WS-Discovery specification.</span></span> <span data-ttu-id="6a2d3-123">In der Signatur wird auf den Text und auf alle Header in Ermittlungs- und Adressierungsnamespaces verwiesen, damit diese nicht manipuliert werden können.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-123">The body and all the headers in discovery and addressing namespaces are referenced in the signature, so they cannot be tampered with.</span></span> <span data-ttu-id="6a2d3-124">Jedes referenzierte Element wird mit der exklusiven Kanonisierung ( <http://www.w3.org/2001/10/xml-exc-c14n#> ) transformiert, und dann wird ein SHA-1-Digestwert ( <http://www.w3.org/2000/09/xmldsig#sha1> ) berechnet.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-124">Each referenced element is transformed using the Exclusive Canonicalization (<http://www.w3.org/2001/10/xml-exc-c14n#>), and then an SHA-1 digest value is computed (<http://www.w3.org/2000/09/xmldsig#sha1>).</span></span> <span data-ttu-id="6a2d3-125">Basierend auf allen referenzierten Elementen und deren Digest-Werten wird der Signatur Wert mithilfe des RSA-Algorithmus ( <http://www.w3.org/2000/09/xmldsig#rsa-sha1> ) berechnet.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-125">Based on all referenced elements and their digest values, the signature value is computed using the RSA algorithm (<http://www.w3.org/2000/09/xmldsig#rsa-sha1>).</span></span>  
  
 <span data-ttu-id="6a2d3-126">Die Meldungen werden mit einem vom Client angegebenen Zertifikat signiert.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-126">The messages are signed with a client-specified certificate.</span></span> <span data-ttu-id="6a2d3-127">Der Speicherort, der Name und der Name des Zertifikat Antragstellers müssen angegeben werden, wenn das Bindungs Element erstellt wird.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-127">The store location, name, and certificate subject name must be specified when the binding element is created.</span></span> <span data-ttu-id="6a2d3-128">Die `KeyId` in der kompakten Signatur stellt den Schlüsselbezeichner des Signaturtokens dar und ist die Schlüsselkennung des Antragstellers (SKI) des Signaturtokens oder, wenn der SKI nicht vorhanden ist, ein SHA-1-Hash des öffentlichen Schlüssels des Signaturtokens.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-128">The `KeyId` in the compact signature represents the key identifier of the signing token and is the Subject Key Identifier (SKI) of the signing token or (if the SKI does not exist) a SHA-1 hash of the public key of the signing token.</span></span>  
  
## <a name="secure-channel-listener"></a><span data-ttu-id="6a2d3-129">Sicherer Kanallistener</span><span class="sxs-lookup"><span data-stu-id="6a2d3-129">Secure Channel Listener</span></span>  

 <span data-ttu-id="6a2d3-130">Der sichere Kanallistener erstellt Eingabe- oder Duplexkanäle, die die kompakte Signatur in empfangenen Meldungen überprüfen.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-130">The secure channel listener creates input or duplex channels that verify the compact signature in received messages.</span></span> <span data-ttu-id="6a2d3-131">Um die Signatur zu überprüfen, wird die `KeyId` verwendet, die in der an die Meldung angefügten kompakten Signatur angegeben ist, um ein Zertifikat aus dem angegebenen Speicher auszuwählen.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-131">To verify the signature, the `KeyId` specified in the compact signature attached to the message is used to select a certificate from the specified store.</span></span> <span data-ttu-id="6a2d3-132">Wenn die Meldung über keine Signatur verfügt oder die Signaturüberprüfung nicht erfolgreich ist, werden die Meldungen verworfen.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-132">If the message does not have a signature or the signature check fails, the messages are dropped.</span></span> <span data-ttu-id="6a2d3-133">Im Beispiel wird zur Verwendung der sicheren Bindung eine Factory definiert, mit der benutzerdefinierte <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> und <xref:System.ServiceModel.Discovery.UdpAnnouncementEndpoint> mit dem zusätzlichen sicheren Ermittlungsbindungselement erstellt werden.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-133">To use the secure binding, the sample defines a factory that creates custom <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> and <xref:System.ServiceModel.Discovery.UdpAnnouncementEndpoint> with the added discovery secure binding element.</span></span> <span data-ttu-id="6a2d3-134">Diese sicheren Endpunkte können in Discovery-Ankündigungslistenern und erkennbaren Diensten verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-134">These secure endpoints can be used in discovery announcement listeners and discoverable services.</span></span>  
  
## <a name="sample-details"></a><span data-ttu-id="6a2d3-135">Beispieldetails</span><span class="sxs-lookup"><span data-stu-id="6a2d3-135">Sample Details</span></span>  

 <span data-ttu-id="6a2d3-136">Das Beispiel enthält eine Bibliothek und 4 Konsolenanwendungen:</span><span class="sxs-lookup"><span data-stu-id="6a2d3-136">The sample includes a library and 4 console applications:</span></span>
  
- <span data-ttu-id="6a2d3-137">**Discoverysecuritychannels**: eine Bibliothek, die die sichere Bindung verfügbar macht.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-137">**DiscoverySecurityChannels**: A library that exposes the secure binding.</span></span> <span data-ttu-id="6a2d3-138">Die Bibliothek berechnet und überprüft die kompakte Signatur für ausgehende/eingehende Meldungen.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-138">The library computes and verifies the compact signature for outgoing/incoming messages.</span></span>  
  
- <span data-ttu-id="6a2d3-139">**Dienst**: ein Dienst, der den ICalculatorService-Vertrag verfügbar macht, selbst gehostet.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-139">**Service**: A service exposing ICalculatorService contract, self hosted.</span></span> <span data-ttu-id="6a2d3-140">Der Dienst wird als erkennbar markiert.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-140">The service is marked as Discoverable.</span></span> <span data-ttu-id="6a2d3-141">Der Benutzer gibt die Details des Zertifikats an, mit dem Meldungen signiert werden. Dazu werden Speicherort, Name und Antragsstellername oder andere eindeutige Bezeichner für das Zertifikat sowie der Speicher, in dem sich die Clientzertifikate befinden, angegeben. (Clientzertifikate sind Zertifikate, mit denen die Signatur auf eingehende Meldungen überprüft werden.)</span><span class="sxs-lookup"><span data-stu-id="6a2d3-141">The user specifies the details of the certificate used to sign messages by specifying the store location and name and the subject name or other unique identifier for the certificate, and the store where the client certificates are located (the certificates used to check signature for incoming messages).</span></span> <span data-ttu-id="6a2d3-142">Auf Grundlage dieser Details wird ein UdpDiscoveryEndpoint mit zusätzlicher Sicherheit erstellt und verwendet.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-142">Based on these details, a UdpDiscoveryEndpoint with added security is built and used.</span></span>  
  
- <span data-ttu-id="6a2d3-143">**Client**: Diese Klasse versucht, einen ICalculatorService zu ermitteln und Methoden für den Dienst aufzurufen.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-143">**Client**: This class tries to discover an ICalculatorService and to call methods on the service.</span></span> <span data-ttu-id="6a2d3-144">Es wird ein <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> mit erweiterter Sicherheit erstellt, mit dem die Meldungen signiert und überprüft werden.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-144">Again, a <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> with added security is built and used to sign and verify the messages.</span></span>  
  
- <span data-ttu-id="6a2d3-145">**Verküncementlistener**: ein selbst gehosteter Dienst, der Online-und Offline Ankündigungen abhört und den sicheren Ankündigungs Endpunkt verwendet.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-145">**AnnouncementListener**: A self-hosted service that listens for online and offline announcements and uses the secure announcement endpoint.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="6a2d3-146">Wenn Setup.bat mehrmals ausgeführt wird, werden Sie vom Zertifikat-Manager dazu aufgefordert, ein Zertifikat auszuwählen, das hinzugefügt werden soll, da es doppelte Zertifikate gibt.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-146">If Setup.bat is run multiple times, the certificate manager prompts you for choosing a certificate to add, as there are duplicate certificates.</span></span> <span data-ttu-id="6a2d3-147">In diesem Fall muss Setup.bat abgebrochen und Cleanup.bat aufgerufen werden, da die Duplikate bereits erstellt wurden.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-147">In that case, Setup.bat should be aborted and Cleanup.bat should be called, because the duplicates have already been created.</span></span> <span data-ttu-id="6a2d3-148">Sie werden außerdem von Cleanup.bat dazu aufgefordert, ein Zertifikat auszuwählen, das gelöscht werden soll.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-148">Cleanup.bat also prompts you to choose a certificate to delete.</span></span> <span data-ttu-id="6a2d3-149">Wählen Sie ein Zertifikat aus der Liste aus, und führen Sie weiterhin Cleanup.bat aus, bis keine Zertifikate mehr verbleiben.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-149">Select a certificate from the list and continue executing Cleanup.bat until no certificates are remaining.</span></span>  
  
#### <a name="to-use-this-sample"></a><span data-ttu-id="6a2d3-150">So verwenden Sie dieses Beispiel</span><span class="sxs-lookup"><span data-stu-id="6a2d3-150">To use this sample</span></span>  
  
1. <span data-ttu-id="6a2d3-151">Führen Sie das Setup.bat Skript aus einer Developer-Eingabeaufforderung für Visual Studio aus.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-151">Execute the Setup.bat script from a Developer Command Prompt for Visual Studio.</span></span> <span data-ttu-id="6a2d3-152">Im diesem Beispiel werden Zertifikate verwendet, um Meldungen zu signieren und zu überprüfen.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-152">The sample uses certificates to sign and verify messages.</span></span> <span data-ttu-id="6a2d3-153">Das Skript erstellt die Zertifikate mit Makecert.exe und installiert sie dann mit Certmgr.exe.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-153">The script creates the certificates using Makecert.exe and then installs them using Certmgr.exe.</span></span> <span data-ttu-id="6a2d3-154">Das Skript muss mit Administratorberechtigungen ausgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-154">The script must be run with administrator privileges.</span></span>  
  
2. <span data-ttu-id="6a2d3-155">Um das Beispiel zu erstellen und auszuführen, öffnen Sie die Datei Security. sln in Visual Studio, und wählen Sie **alle neu erstellen** aus.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-155">To build and run the sample, open the Security.sln file in Visual Studio and choose **Rebuild All**.</span></span> <span data-ttu-id="6a2d3-156">Aktualisieren Sie die Projektmappeneigenschaften, um mehrere Projekte zu starten: Wählen Sie **Start** für alle Projekte außer discoverysecurechannels aus.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-156">Update the solution properties to start multiple projects: select **Start** for all projects except DiscoverySecureChannels.</span></span> <span data-ttu-id="6a2d3-157">Führen Sie die Projektmappe wie gewohnt aus.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-157">Run the solution normally.</span></span>  
  
3. <span data-ttu-id="6a2d3-158">Nachdem Sie das Beispiel abgeschlossen haben, führen Sie das Skript Cleanup.bat aus. Damit werden alle für dieses Beispiel erstellten Zertifikate entfernt.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-158">After you are done with the sample, execute the Cleanup.bat script that removes the certificates created for this sample.</span></span>  
  
> [!IMPORTANT]
> <span data-ttu-id="6a2d3-159">Die Beispiele sind möglicherweise bereits auf dem Computer installiert.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-159">The samples may already be installed on your machine.</span></span> <span data-ttu-id="6a2d3-160">Suchen Sie nach dem folgenden Verzeichnis (Standardverzeichnis), bevor Sie fortfahren.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-160">Check for the following (default) directory before continuing.</span></span>  
>
> `<InstallDrive>:\WF_WCF_Samples`  
>
> <span data-ttu-id="6a2d3-161">Wenn dieses Verzeichnis nicht vorhanden ist, wechseln Sie zu [Windows Communication Foundation (WCF) und Windows Workflow Foundation (WF)-Beispiele für .NET Framework 4](https://www.microsoft.com/download/details.aspx?id=21459) , um alle Windows Communication Foundation (WCF) und Beispiele herunterzuladen [!INCLUDE[wf1](../../../../includes/wf1-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="6a2d3-161">If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://www.microsoft.com/download/details.aspx?id=21459) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples.</span></span> <span data-ttu-id="6a2d3-162">Dieses Beispiel befindet sich im folgenden Verzeichnis.</span><span class="sxs-lookup"><span data-stu-id="6a2d3-162">This sample is located in the following directory.</span></span>  
>
> `<InstallDrive>:\WF_WCF_Samples\WCF\Scenario\DiscoveryScenario`  
